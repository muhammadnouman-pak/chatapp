<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WhatsApp-Style Chat</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #f4f4f4; }
    .main-content { padding: 40px; max-width: 800px; margin: auto; }
    .chat-trigger {
      position: fixed; bottom: 20px; right: 20px;
      background: #25d366; color: white; border: none;
      border-radius: 50%; width: 60px; height: 60px;
      font-size: 24px; cursor: pointer;
    }
    .chat-app {
      position: fixed; bottom: 90px; right: 20px;
      width: 350px; height: 500px; background: #ece5dd;
      border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.3);
      display: none; flex-direction: column; overflow: hidden;
    }
    .chat-header {
      background: #075e54; color: white; padding: 10px;
      font-weight: bold; display: flex; justify-content: space-between;
    }
    .chat-body {
      flex-grow: 1; padding: 10px; overflow-y: auto; background: #fff;
    }
    .chat-footer {
      padding: 10px; background: #f0f0f0; display: flex; gap: 5px;
    }
    .chat-footer input[type="text"] {
      flex-grow: 1; padding: 8px; border-radius: 20px; border: 1px solid #ccc;
    }
    .chat-footer button {
      background: #25d366; border: none; color: white;
      padding: 8px 12px; border-radius: 50%; cursor: pointer;
    }
    .message {
      max-width: 70%; margin-bottom: 10px; padding: 10px;
      border-radius: 10px; position: relative;
    }
    .sent { background: #dcf8c6; margin-left: auto; }
    .received { background: #fff; }
    .timestamp { font-size: 0.8em; color: #888; text-align: right; margin-top: 5px; }
    .status { font-size: 0.8em; color: #888; position: absolute; bottom: 5px; right: 10px; }
    img.chat-img { max-width: 100%; border-radius: 8px; margin-top: 5px; }
  </style>
</head>
<body>

<div class="main-content">
  <h1>Welcome to My Website</h1>
  <p>This is an informative page. Click the chat button to start messaging.</p>
</div>

<button class="chat-trigger" onclick="toggleChat()">💬</button>

<div class="chat-app" id="chatApp">
  <div class="chat-header">Chat <span><button onclick="logout()">⎋</button></span></div>
  <div class="chat-body" id="chatBody"></div>
  <div class="chat-footer">
    <input type="text" id="messageInput" placeholder="Type a message 😊" />
    <input type="file" id="imageInput" />
    <button onclick="sendMessage()">➤</button>
  </div>
</div>

<script>
  const supabase = supabase.createClient(
    'https://cuuxeukxhgplznxaadvs.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN1dXhldWt4aGdwbHpueGFhZHZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0MzM1NDUsImV4cCI6MjA3MzAwOTU0NX0.QiPsvo_pjNJ95-xxH8OC_XOFSRZ-hrGpXtHV30sy14Y'
  );

  let currentUser = null;

  async function toggleChat() {
    const chat = document.getElementById('chatApp');
    chat.style.display = chat.style.display === 'flex' ? 'none' : 'flex';
    if (!currentUser) await login();
  }

  async function login() {
    const email = prompt("Enter your email:");
    const password = prompt("Enter your password:");
    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) return alert("Login failed");
    currentUser = data.user;
    subscribeToMessages();
    loadMessages();
  }

  async function logout() {
    await supabase.auth.signOut();
    currentUser = null;
    document.getElementById('chatBody').innerHTML = '';
  }

  async function sendMessage() {
    const text = document.getElementById('messageInput').value;
    const fileInput = document.getElementById('imageInput');
    let imageUrl = '';

    if (fileInput.files.length > 0) {
      const file = fileInput.files[0];
      const { data, error } = await supabase.storage
        .from('image-storage')
        .upload(`chat/${Date.now()}_${file.name}`, file);
      if (!error) {
        const { data: urlData } = supabase.storage
          .from('image-storage')
          .getPublicUrl(data.path);
        imageUrl = urlData.publicUrl;
      }
    }

    await supabase.from('messages').insert([{
      sender_id: currentUser.id,
      text,
      image_url: imageUrl,
      status: 'sent'
    }]);

    document.getElementById('messageInput').value = '';
    fileInput.value = '';
  }

  async function loadMessages() {
    const { data } = await supabase.from('messages').select('*').order('created_at', { ascending: true });
    renderMessages(data);
  }

  function renderMessages(messages) {
    const chatBody = document.getElementById('chatBody');
    chatBody.innerHTML = '';
    messages.forEach(msg => {
      const div = document.createElement('div');
      div.className = 'message ' + (msg.sender_id === currentUser.id ? 'sent' : 'received');
      div.innerHTML = msg.text || '';
      if (msg.image_url) {
        div.innerHTML += `<br><img class="chat-img" src="${msg.image_url}" />`;
      }
      div.innerHTML += `<div class="timestamp">${new Date(msg.created_at).toLocaleTimeString()}</div>`;
      if (msg.sender_id === currentUser.id) {
        div.innerHTML += `<div class="status">${getStatusIcon(msg.status)}</div>`;
      }
      chatBody.appendChild(div);
    });
    chatBody.scrollTop = chatBody.scrollHeight;
  }

  function getStatusIcon(status) {
    if (status === 'sent') return '✔️';
    if (status === 'delivered') return '✔✔️';
    if (status === 'seen') return '✔✔️🔵';
    return '';
  }

  function subscribeToMessages() {
    supabase
      .channel('chat')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'messages' }, payload => {
        loadMessages();
      })
      .subscribe();
  }
</script>

</body>
</html>
